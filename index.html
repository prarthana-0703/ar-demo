<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>VIT SJT Navigation (Final)</title>

<link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet">

<style>
    /* --- RESET & LAYOUT --- */
    body { margin: 0; overflow: hidden; background: black; font-family: 'Segoe UI', sans-serif; }

    /* Camera Feed */
    #camera-feed {
        position: fixed; top: 0; left: 0;
        width: 100vw; height: 100vh;
        object-fit: cover; z-index: -1;
    }

    /* UI Layer */
    #ui-layer {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        display: flex; flex-direction: column;
        pointer-events: none;
    }

    /* Top Debug Panel (Hidden by default, un-comment to see) */
    #debug-panel {
        position: absolute; top: 10px; left: 10px;
        background: rgba(0, 0, 0, 0.7);
        color: #00ff00; padding: 8px;
        font-size: 12px; font-family: monospace;
        border: 1px solid #00ff00;
        border-radius: 4px;
        display: none; /* Hide for final demo */
    }

    /* Center Distance Badge */
    .info-badge {
        margin-top: 80px; align-self: center;
        background: rgba(0, 0, 0, 0.85);
        color: white; padding: 15px 40px;
        border-radius: 50px; text-align: center;
        border: 2px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        transition: background 0.3s;
    }
    .arrived {
        background: rgba(46, 204, 113, 0.9) !important; /* Green on arrival */
        border-color: #2ecc71 !important;
    }

    #dist-text { font-size: 36px; font-weight: 800; }
    #status-text { font-size: 14px; color: #ccc; text-transform: uppercase; letter-spacing: 1px; }

    /* AR Arrow */
    #arrow-container {
        flex-grow: 1;
        display: flex; align-items: center; justify-content: center;
        perspective: 1000px;
    }
    #arrow-img {
        width: 180px; height: 180px;
        background-image: url("https://cdn-icons-png.flaticon.com/512/724/724927.png");
        background-size: contain; background-repeat: no-repeat;
        filter: drop-shadow(0 0 15px #00e5ff);
        transition: transform 0.1s linear; 
    }

    /* Mini Map */
    #mini-map-container {
        position: absolute; bottom: 30px; right: 20px;
        width: 160px; height: 160px;
        border-radius: 20px; overflow: hidden;
        border: 3px solid white;
        background: #222; pointer-events: auto;
    }
    #map { width: 100%; height: 100%; }

    /* Start Button */
    #start-btn {
        position: fixed; top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 50px; font-size: 20px; font-weight: bold;
        background: #007cbf; color: white; border: none;
        border-radius: 50px; cursor: pointer; z-index: 1000;
        box-shadow: 0 0 20px rgba(0, 124, 191, 0.6);
    }
</style>
</head>

<body>

    <video id="camera-feed" autoplay playsinline muted></video>

    <div id="ui-layer">
        <div id="debug-panel">
            GPS Acc: <span id="dbg-acc">--</span> m<br>
            Node: <span id="dbg-idx">0</span><br>
            Next: <span id="dbg-dist">--</span> m
        </div>

        <div class="info-badge" id="badge">
            <div id="dist-text">-- m</div>
            <div id="status-text">Ready</div>
        </div>

        <div id="arrow-container">
            <div id="arrow-img"></div>
        </div>

        <div id="mini-map-container">
            <div id="map"></div>
        </div>
    </div>

    <button id="start-btn" onclick="startAndroidSystem()">START NAVIGATION</button>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>

<script>
    /* ================= 1. CONFIGURATION ================= */
    const MAPBOX_TOKEN = "pk.eyJ1IjoiaGVtYW50aDg1MDMiLCJhIjoiY21rNzV5c2w2MHlqeTNncjI5bjkyeWJwaiJ9.NnunzAB_24Ntn83H5hRcyQ";
    const DESTINATION = { lat: 12.9719, lng: 79.1602 }; // VIT SJT
    const NODE_SWITCH_DIST = 15; // Meters
    const ARRIVAL_DIST = 15; // Meters (When to say "You Arrived")
    const COMPASS_SMOOTHING = 0.15; // Higher = Smoother, Lower = Faster

    /* ================= 2. STATE ================= */
    let map, routeCoords = [], nextNodeIndex = 0;
    let currentHeading = 0, smoothedHeading = 0;
    let lastTargetBearing = 0; // Fixes Issue #1
    let isFetchingRoute = false; // Fixes Issue #2
    let hasArrived = false; // Fixes Issue #3

    /* ================= 3. ANDROID STARTUP ================= */
    async function startAndroidSystem() {
        document.getElementById("start-btn").style.display = "none";
        document.getElementById("status-text").innerText = "Initializing Sensors...";

        // A. Camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            });
            document.getElementById("camera-feed").srcObject = stream;
        } catch(e) { 
            alert("Camera failed. Check permissions."); 
        }

        // B. Mapbox Init
        mapboxgl.accessToken = MAPBOX_TOKEN;
        map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/dark-v11",
            center: [DESTINATION.lng, DESTINATION.lat],
            zoom: 17, attributionControl: false
        });

        // C. Compass
        if ('ondeviceorientationabsolute' in window) {
            window.addEventListener("deviceorientationabsolute", handleAndroidOrientation);
        } else {
            window.addEventListener("deviceorientation", handleAndroidOrientation);
        }

        // D. GPS
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(handleLocation, err => console.warn(err), {
                enableHighAccuracy: true, maximumAge: 0, timeout: 5000
            });
        }
    }

    /* ================= 4. LOCATION LOGIC ================= */
    function handleLocation(pos) {
        if (hasArrived) return; // Stop processing if arrived

        const { latitude: lat, longitude: lng, accuracy } = pos.coords;
        
        document.getElementById("dbg-acc").innerText = Math.round(accuracy);
        if (map) map.setCenter([lng, lat]);

        // Filter bad GPS data
        if (accuracy > 50) return;

        // Fetch Route (Protected by flag - Fix #2)
        if (routeCoords.length === 0 && !isFetchingRoute) {
            fetchRoute(lat, lng);
        } else if (routeCoords.length > 0) {
            updateGuidance(lat, lng);
        }
    }

    async function fetchRoute(lat, lng) {
        if (isFetchingRoute) return; // Double check
        isFetchingRoute = true;
        
        document.getElementById("status-text").innerText = "Finding Path...";
        
        const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${lng},${lat};${DESTINATION.lng},${DESTINATION.lat}?steps=true&geometries=geojson&access_token=${MAPBOX_TOKEN}`;

        try {
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.routes && data.routes.length > 0) {
                routeCoords = data.routes[0].geometry.coordinates;
                drawRoute(routeCoords);
                document.getElementById("status-text").innerText = "Follow Arrow";
                isFetchingRoute = false; // Reset flag
            }
        } catch (e) { 
            console.error(e); 
            isFetchingRoute = false; 
        }
    }

    /* ================= 5. GUIDANCE ================= */
    function updateGuidance(lat, lng) {
        let [tLng, tLat] = routeCoords[nextNodeIndex];
        let distToNode = getDistance(lat, lng, tLat, tLng);
        let totalDist = getDistance(lat, lng, DESTINATION.lat, DESTINATION.lng);

        // ARRIVAL CHECK (Fix #3)
        if (totalDist < ARRIVAL_DIST) {
            triggerArrival();
            return;
        }

        document.getElementById("dbg-idx").innerText = nextNodeIndex;
        document.getElementById("dbg-dist").innerText = Math.round(distToNode);

        // Switch to next node
        if (distToNode < NODE_SWITCH_DIST && nextNodeIndex < routeCoords.length - 1) {
            nextNodeIndex++;
        }

        document.getElementById("dist-text").innerText = Math.round(totalDist) + " m";

        // Calculate Bearing & Store it (Fix #1)
        lastTargetBearing = getBearing(lat, lng, tLat, tLng);
        updateArrow(); // Immediate update
    }

    function triggerArrival() {
        hasArrived = true;
        document.getElementById("dist-text").innerText = "0 m";
        document.getElementById("status-text").innerText = "YOU HAVE ARRIVED! ";
        document.getElementById("badge").classList.add("arrived");
        document.getElementById("arrow-img").style.display = "none"; // Hide arrow
    }

    /* ================= 6. ANDROID COMPASS ================= */
    function handleAndroidOrientation(e) {
        if (hasArrived) return;

        let alpha = e.alpha;
        if(e.webkitCompassHeading) return; 

        // Raw Heading
        let heading = 360 - alpha; 

        // Smoothing Logic (Fix #4)
        // Handle wrap-around (359 -> 1)
        let diff = heading - smoothedHeading;
        while (diff > 180) diff -= 360;
        while (diff < -180) diff += 360;
        
        smoothedHeading += diff * COMPASS_SMOOTHING;
        currentHeading = smoothedHeading;

        // Update arrow on every rotation (Fix #1)
        if (routeCoords.length > 0) {
            updateArrow();
        }
    }

    function updateArrow() {
        // Uses global 'lastTargetBearing' so it works even if GPS is silent
        let rot = lastTargetBearing - currentHeading;
        
        while (rot < -180) rot += 360;
        while (rot > 180) rot -= 360;

        document.getElementById("arrow-img").style.transform = `rotate(${rot}deg)`;
    }

    /* ================= 7. MAP & MATH ================= */
    function drawRoute(coords) {
        const addLayer = () => {
            if (!map.getSource('route')) {
                map.addSource('route', {
                    type: 'geojson',
                    data: { type: 'Feature', geometry: { type: 'LineString', coordinates: coords } }
                });
                map.addLayer({
                    id: 'route', type: 'line', source: 'route',
                    paint: { 'line-color': '#00e5ff', 'line-width': 5 }
                });
            }
        };
        if (map.loaded()) addLayer();
        else map.on('load', addLayer);
    }

    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const 1 = lat1 * Math.PI/180, 2 = lat2 * Math.PI/180;
        const  = (lat2-lat1) * Math.PI/180, 位 = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(/2)**2 + Math.cos(1)*Math.cos(2)*Math.sin(位/2)**2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function getBearing(lat1, lon1, lat2, lon2) {
        const 1 = lat1 * Math.PI/180, 2 = lat2 * Math.PI/180;
        const 位 = (lon2-lon1) * Math.PI/180;
        const y = Math.sin(位) * Math.cos(2);
        const x = Math.cos(1)*Math.sin(2) - Math.sin(1)*Math.cos(2)*Math.cos(位);
        return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
    }
</script>
</body>
</html>
